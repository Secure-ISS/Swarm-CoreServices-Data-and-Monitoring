# Database alerting rules for Distributed PostgreSQL Cluster

groups:
  - name: postgresql
    interval: 15s
    rules:
      # PostgreSQL instance down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL instance {{ $labels.instance }} is down"
          description: "PostgreSQL instance {{ $labels.instance }} has been down for more than 1 minute"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/postgresql-down"

      # Too many connections
      - alert: PostgreSQLTooManyConnections
        expr: |
          (sum by (instance) (pg_stat_activity_count) /
           pg_settings_max_connections) > 0.8
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} has too many connections"
          description: "PostgreSQL instance {{ $labels.instance }} is using {{ $value | humanizePercentage }} of max connections"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/too-many-connections"

      # Connection pool exhaustion
      - alert: PostgreSQLConnectionPoolExhausted
        expr: |
          (sum by (instance) (pg_stat_activity_count{state="active"}) /
           pg_settings_max_connections) > 0.9
        for: 2m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} connection pool nearly exhausted"
          description: "PostgreSQL instance {{ $labels.instance }} is using {{ $value | humanizePercentage }} of max connections"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/connection-pool-exhausted"

      # Low cache hit ratio
      - alert: PostgreSQLLowCacheHitRatio
        expr: |
          (pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read)) < 0.95
        for: 15m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} has low cache hit ratio"
          description: "Cache hit ratio is {{ $value | humanizePercentage }} on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/low-cache-hit-ratio"

      # High transaction rate
      - alert: PostgreSQLHighTransactionRate
        expr: rate(pg_stat_database_xact_commit[5m]) > 1000
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} has high transaction rate"
          description: "Transaction rate is {{ $value | humanize }} TPS on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/high-transaction-rate"

      # Replication lag
      - alert: PostgreSQLReplicationLag
        expr: |
          pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL replication lag on {{ $labels.replica }}"
          description: "Replication lag is {{ $value }}s on {{ $labels.replica }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/replication-lag"

      # Replication lag critical
      - alert: PostgreSQLReplicationLagCritical
        expr: |
          pg_replication_lag > 300
        for: 2m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL replication lag critical on {{ $labels.replica }}"
          description: "Replication lag is {{ $value }}s on {{ $labels.replica }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/replication-lag-critical"

      # Replication broken
      - alert: PostgreSQLReplicationBroken
        expr: pg_replication_status == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL replication broken on {{ $labels.replica }}"
          description: "Replication is not streaming on {{ $labels.replica }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/replication-broken"

      # Dead tuples high
      - alert: PostgreSQLDeadTuplesHigh
        expr: |
          (pg_stat_user_tables_n_dead_tup /
           (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup)) > 0.1
        for: 30m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL {{ $labels.instance }} has high dead tuples"
          description: "Table {{ $labels.schemaname }}.{{ $labels.tablename }} has {{ $value | humanizePercentage }} dead tuples"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/high-dead-tuples"

      # Table bloat high
      - alert: PostgreSQLTableBloatHigh
        expr: |
          dpg_table_bloat_ratio > 0.3
        for: 1h
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL table bloat high on {{ $labels.instance }}"
          description: "Table {{ $labels.schemaname }}.{{ $labels.tablename }} has {{ $value | humanizePercentage }} bloat"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/table-bloat"

      # Long-running queries
      - alert: PostgreSQLLongRunningQueries
        expr: |
          max(dpg_query_duration_seconds) > 300
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "PostgreSQL has long-running queries on {{ $labels.instance }}"
          description: "Query has been running for {{ $value }}s on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/long-running-queries"

      # Checkpoint frequency high
      - alert: PostgreSQLCheckpointFrequencyHigh
        expr: |
          rate(pg_stat_bgwriter_checkpoints_req[5m]) >
          rate(pg_stat_bgwriter_checkpoints_timed[5m]) * 2
        for: 15m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "PostgreSQL checkpoint frequency high on {{ $labels.instance }}"
          description: "Requested checkpoints are happening more frequently than scheduled on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/checkpoint-frequency"

      # Temporary files usage high
      - alert: PostgreSQLTempFilesHigh
        expr: rate(pg_stat_database_temp_bytes[5m]) > 10485760
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "PostgreSQL temporary files usage high on {{ $labels.instance }}"
          description: "Temporary files are being created at {{ $value | humanize }}B/s on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/temp-files-high"

      # Disk space low
      - alert: PostgreSQLDiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql/data"} /
           node_filesystem_size_bytes{mountpoint="/var/lib/postgresql/data"}) < 0.2
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "PostgreSQL disk space low on {{ $labels.instance }}"
          description: "Disk space is {{ $value | humanizePercentage }} remaining on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/disk-space-low"

      # Disk space critical
      - alert: PostgreSQLDiskSpaceCritical
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/var/lib/postgresql/data"} /
           node_filesystem_size_bytes{mountpoint="/var/lib/postgresql/data"}) < 0.1
        for: 2m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL disk space critical on {{ $labels.instance }}"
          description: "Disk space is {{ $value | humanizePercentage }} remaining on {{ $labels.instance }}"
          runbook_url: "https://docs.dpg-cluster.local/runbooks/disk-space-critical"
