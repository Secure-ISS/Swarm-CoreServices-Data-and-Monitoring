# etcd Configuration for Patroni High Availability
# 3-node etcd cluster for distributed consensus

# ============================================
# MEMBER CONFIGURATION
# ============================================

# Node name (unique per node)
# Change to: etcd-1, etcd-2, etcd-3
name: 'etcd-1'

# Data directory
data-dir: '/var/lib/etcd'

# WAL directory (optional - separate disk for performance)
# wal-dir: '/var/lib/etcd/wal'

# Snapshot configuration
snapshot-count: 10000  # Take snapshot every 10000 transactions
heartbeat-interval: 100  # 100ms heartbeat
election-timeout: 1000  # 1s election timeout

# Maximum snapshot files to retain
max-snapshots: 5
max-wals: 5

# ============================================
# CLUSTERING CONFIGURATION
# ============================================

# Advertise peer URLs (for cluster communication)
# Change per node:
# etcd-1: http://etcd-1:2380
# etcd-2: http://etcd-2:2380
# etcd-3: http://etcd-3:2380
initial-advertise-peer-urls: 'http://etcd-1:2380'

# Listen peer URLs (Raft protocol)
listen-peer-urls: 'http://0.0.0.0:2380'

# Advertise client URLs (for Patroni clients)
initial-advertise-client-urls: 'http://etcd-1:2379'

# Listen client URLs (Patroni connections)
listen-client-urls: 'http://0.0.0.0:2379'

# Initial cluster configuration
# All 3 nodes listed with their peer URLs
initial-cluster: 'etcd-1=http://etcd-1:2380,etcd-2=http://etcd-2:2380,etcd-3=http://etcd-3:2380'

# Cluster state
# 'new' for new cluster, 'existing' when adding to existing cluster
initial-cluster-state: 'new'

# Initial cluster token (unique identifier for cluster)
initial-cluster-token: 'postgres-cluster-etcd'

# ============================================
# CLIENT CONFIGURATION
# ============================================

# Enable client authentication (optional)
# Uncomment for SSL/TLS:
# client-cert-auth: true
# trusted-ca-file: '/etc/ssl/certs/etcd-ca.crt'
# cert-file: '/etc/ssl/certs/etcd-server.crt'
# key-file: '/etc/ssl/private/etcd-server.key'

# ============================================
# PEER CONFIGURATION
# ============================================

# Enable peer authentication (optional)
# Uncomment for SSL/TLS:
# peer-client-cert-auth: true
# peer-trusted-ca-file: '/etc/ssl/certs/etcd-ca.crt'
# peer-cert-file: '/etc/ssl/certs/etcd-peer.crt'
# peer-key-file: '/etc/ssl/private/etcd-peer.key'

# ============================================
# LOGGING
# ============================================

# Log level: debug, info, warn, error, panic, fatal
log-level: 'info'

# Log outputs
log-outputs: ['/var/log/etcd/etcd.log']

# ============================================
# PERFORMANCE TUNING
# ============================================

# Quota backend size (8GB storage limit)
quota-backend-bytes: 8589934592

# Maximum number of inflight requests
max-inflight-msgs: 5000

# Maximum number of committed entries in memory
max-committed-size-bytes: 33554432  # 32MB

# ============================================
# SECURITY
# ============================================

# Enable auto-compaction (clean up old revisions)
auto-compaction-mode: 'periodic'
auto-compaction-retention: '1h'

# ============================================
# METRICS
# ============================================

# Enable metrics endpoint
listen-metrics-urls: 'http://0.0.0.0:2381'

# ============================================
# OPERATIONAL
# ============================================

# Enable strict reconfiguration check
strict-reconfig-check: true

# Enable pprof profiling
# enable-pprof: true

# ============================================
# NOTES
# ============================================
#
# Docker Swarm Deployment:
# - Use Docker configs to inject this file
# - Override 'name' and URLs per node via environment variables
# - Example environment overrides:
#   ETCD_NAME=etcd-2
#   ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd-2:2380
#   ETCD_INITIAL_ADVERTISE_CLIENT_URLS=http://etcd-2:2379
#
# Health Checks:
# - etcdctl endpoint health --endpoints=http://etcd-1:2379,http://etcd-2:2379,http://etcd-3:2379
# - etcdctl member list --endpoints=http://etcd-1:2379
#
# Maintenance:
# - Defragment: etcdctl defrag --endpoints=http://etcd-1:2379
# - Compact: etcdctl compact <revision>
# - Snapshot: etcdctl snapshot save /backup/etcd-snapshot.db
#
# Recovery:
# - Restore from snapshot: etcdctl snapshot restore /backup/etcd-snapshot.db
