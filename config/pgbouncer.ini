;; PgBouncer Configuration for Distributed PostgreSQL Cluster
;; This provides connection pooling and routing at the network level

[databases]
;; Database aliases and connection strings
;; Format: alias = host=... port=... dbname=... user=... password=...

;; Coordinator node (primary for writes and distributed queries)
distributed_postgres_cluster = host=localhost port=5432 dbname=distributed_postgres_cluster user=dpg_cluster password=dpg_cluster_2026 pool_size=25 reserve_pool=5

;; Shared knowledge database
claude_flow_shared = host=localhost port=5432 dbname=claude_flow_shared user=shared_user password=shared_knowledge_2026 pool_size=15 reserve_pool=3

;; Worker nodes (for Citus-style sharding)
;; Uncomment and configure when workers are deployed
; worker_shard_0 = host=worker-0.example.com port=5432 dbname=shard_0 user=dpg_cluster password=dpg_cluster_2026 pool_size=20
; worker_shard_1 = host=worker-1.example.com port=5432 dbname=shard_1 user=dpg_cluster password=dpg_cluster_2026 pool_size=20
; worker_shard_2 = host=worker-2.example.com port=5432 dbname=shard_2 user=dpg_cluster password=dpg_cluster_2026 pool_size=20

;; Read replicas (for read scaling)
; replica_1 = host=replica-1.example.com port=5432 dbname=distributed_postgres_cluster user=dpg_cluster password=dpg_cluster_2026 pool_size=20
; replica_2 = host=replica-2.example.com port=5432 dbname=distributed_postgres_cluster user=dpg_cluster password=dpg_cluster_2026 pool_size=20

[pgbouncer]
;;;
;;; Administrative settings
;;;

;; Listen address and port
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket location (optional)
unix_socket_dir = /var/run/pgbouncer
unix_socket_mode = 0777

;;;
;;; Authentication settings
;;;

;; Authentication type
;; Options: pam, hba, cert, md5, scram-sha-256, plain, trust, any
auth_type = md5

;; Authentication file (userlist.txt format: "username" "password")
auth_file = /etc/pgbouncer/userlist.txt

;; HBA-style authentication file (optional)
; auth_hba_file = /etc/pgbouncer/pg_hba.conf

;;;
;;; Pooling settings
;;;

;; Pool mode
;; - session: Connection returned to pool after client disconnects (default)
;; - transaction: Connection returned after each transaction
;; - statement: Connection returned after each statement (not recommended)
pool_mode = transaction

;; Maximum number of client connections
max_client_conn = 1000

;; Default pool size (per user+database pair)
default_pool_size = 25

;; Minimum pool size to keep alive
min_pool_size = 5

;; Reserved connections for urgent queries
reserve_pool_size = 5

;; How many additional connections to allow when pool is full
reserve_pool_timeout = 3

;; Maximum number of server connections per database
max_db_connections = 100

;; Maximum number of server connections per user
max_user_connections = 100

;;;
;;; Connection limits and timeouts
;;;

;; Server connection lifetime (seconds)
;; Close server connection after this time
server_lifetime = 3600

;; Server idle timeout (seconds)
;; Close idle server connections after this time
server_idle_timeout = 600

;; Client idle timeout (seconds)
;; Close idle client connections after this time
server_connect_timeout = 15

;; Query timeout (seconds, 0 = disabled)
query_timeout = 0

;; Query wait timeout (seconds)
;; Client waits this long for a connection from pool
query_wait_timeout = 120

;; Client login timeout
client_login_timeout = 60

;; Idle transaction timeout
idle_transaction_timeout = 600

;;;
;;; Connection behavior
;;;

;; Close server connection if its been connected longer
server_check_delay = 30

;; Use SO_REUSEPORT socket option
so_reuseport = 1

;; TCP keepalive settings
tcp_keepalive = 1
tcp_keepalive_idle = 60
tcp_keepalive_interval = 10
tcp_keepalive_count = 5

;; TCP user timeout
tcp_user_timeout = 0

;;;
;;; TLS settings (optional)
;;;

;; TLS configuration
; client_tls_sslmode = disable
; client_tls_ca_file = /path/to/ca.crt
; client_tls_cert_file = /path/to/client.crt
; client_tls_key_file = /path/to/client.key

; server_tls_sslmode = prefer
; server_tls_ca_file = /path/to/ca.crt
; server_tls_cert_file = /path/to/server.crt
; server_tls_key_file = /path/to/server.key

;;;
;;; Logging
;;;

;; Log file location
logfile = /var/log/pgbouncer/pgbouncer.log

;; Syslog integration
; syslog = 1
; syslog_ident = pgbouncer
; syslog_facility = daemon

;; Log connections
log_connections = 1

;; Log disconnections
log_disconnections = 1

;; Log pool operations
log_pooler_errors = 1

;; Stats period (seconds)
stats_period = 60

;; Verbose logging (0-2)
verbose = 0

;;;
;;; Admin console
;;;

;; Admin users (can run all commands)
admin_users = postgres, dpg_cluster

;; Stats users (can run SHOW commands)
stats_users = postgres, dpg_cluster

;;;
;;; Performance tuning
;;;

;; DNS lookup caching
dns_max_ttl = 15
dns_nxdomain_ttl = 15
dns_zone_check_period = 0

;; Disable PAUSE in transaction mode
disable_pqexec = 0

;; Application name tracking
application_name_add_host = 1

;; Track extra parameters
track_extra_parameters = IntervalStyle

;;;
;;; Load balancing (for read replicas)
;;;

;; Random load balancing across identical database entries
; server_round_robin = 1

;; Prefer later servers (for read replicas)
; server_login_retry = 1
; server_reset_query = DISCARD ALL
; server_reset_query_always = 0

[console]
;; Access to admin console
;; Connect via: psql -h localhost -p 6432 -U postgres pgbouncer
