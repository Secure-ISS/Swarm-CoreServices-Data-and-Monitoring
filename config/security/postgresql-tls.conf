# PostgreSQL TLS/SSL Configuration
# ==================================
# This file configures Transport Layer Security for PostgreSQL connections
# Include in postgresql.conf: include = '/etc/postgresql/security/postgresql-tls.conf'

# ============================================================================
# SSL/TLS ENABLEMENT
# ============================================================================

# Enable SSL connections
ssl = on

# SSL certificate paths (Docker secrets mounted here)
ssl_ca_file = '/run/secrets/postgres_ca_cert'
ssl_cert_file = '/run/secrets/postgres_server_cert'
ssl_key_file = '/run/secrets/postgres_server_key'

# Certificate Revocation List (for revoked certificates)
ssl_crl_file = '/etc/postgresql/certs/crl.pem'

# ============================================================================
# TLS PROTOCOL SETTINGS
# ============================================================================

# Minimum TLS version (enforce TLS 1.3 for maximum security)
# Options: TLSv1.2, TLSv1.3
ssl_min_protocol_version = 'TLSv1.3'

# Maximum TLS version (set to TLSv1.3 to disable older protocols)
ssl_max_protocol_version = 'TLSv1.3'

# Prefer server cipher preferences over client
ssl_prefer_server_ciphers = on

# ============================================================================
# CIPHER SUITES (TLS 1.3 - Modern, Secure Ciphers Only)
# ============================================================================

# Strong cipher suites (TLS 1.3)
# - TLS_AES_256_GCM_SHA384: AES-256 with GCM (best security)
# - TLS_CHACHA20_POLY1305_SHA256: ChaCha20 (fast on mobile devices)
# - TLS_AES_128_GCM_SHA256: AES-128 with GCM (good performance)
ssl_ciphers = 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256'

# ============================================================================
# DIFFIE-HELLMAN PARAMETERS (Perfect Forward Secrecy)
# ============================================================================

# DH parameters file (generate with: openssl dhparam -out dhparams.pem 4096)
ssl_dh_params_file = '/etc/postgresql/certs/dhparams.pem'

# ============================================================================
# CERTIFICATE VALIDATION
# ============================================================================

# Require client certificates for all connections
# Enforced in pg_hba.conf with: clientcert=verify-full

# ============================================================================
# SSL PASSPHRASE HANDLING (For Encrypted Private Keys)
# ============================================================================

# Command to retrieve SSL private key passphrase
# This prevents storing passphrases in plaintext
ssl_passphrase_command = '/usr/local/bin/get-ssl-passphrase.sh'

# Allow passphrase command on configuration reload
ssl_passphrase_command_supports_reload = on

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# Listen on all interfaces (restrict in pg_hba.conf and firewall)
listen_addresses = '*'

# Default port
port = 5432

# Maximum connections (adjust based on workload)
max_connections = 500

# Reserved connections for superuser
superuser_reserved_connections = 10

# ============================================================================
# AUTHENTICATION SETTINGS
# ============================================================================

# Password encryption method (SCRAM-SHA-256 is strongest)
password_encryption = 'scram-sha-256'

# Authentication timeout (30 seconds)
authentication_timeout = 30s

# ============================================================================
# CONNECTION SECURITY
# ============================================================================

# TCP keepalive settings (detect dead connections)
tcp_keepalives_idle = 600        # 10 minutes
tcp_keepalives_interval = 10     # 10 seconds
tcp_keepalives_count = 5         # 5 retries

# Statement timeout (prevent long-running queries)
statement_timeout = 300000       # 5 minutes

# Idle in transaction timeout (prevent dangling transactions)
idle_in_transaction_session_timeout = 600000  # 10 minutes

# ============================================================================
# LOGGING (Security-Related Events)
# ============================================================================

# Log SSL connections
log_connections = on
log_disconnections = on

# Log hostname
log_hostname = on

# Log line prefix (timestamp, PID, user, database, client)
log_line_prefix = '%t [%p] %u@%d [%h] '

# ============================================================================
# CERTIFICATE MONITORING
# ============================================================================

# PostgreSQL does not have built-in certificate expiry warnings
# Use external monitoring: scripts/security/check-cert-expiry.sh

# ============================================================================
# SECURITY HARDENING
# ============================================================================

# Disable unencrypted connections (enforced in pg_hba.conf with hostssl)
# Any 'host' (non-SSL) entries in pg_hba.conf will fail

# Prevent SSL downgrade attacks
# (TLS 1.3 prevents this by design)

# ============================================================================
# REPLICATION SECURITY
# ============================================================================

# SSL for streaming replication
# Configured in recovery.conf / primary_conninfo:
# primary_conninfo = 'host=pg-coordinator port=5432 user=replicator
#                     sslmode=verify-full
#                     sslcert=/etc/postgresql/certs/client.crt
#                     sslkey=/etc/postgresql/certs/client.key
#                     sslrootcert=/etc/postgresql/certs/ca.crt'

# ============================================================================
# TESTING SSL CONFIGURATION
# ============================================================================
#
# 1. Check SSL is enabled:
#    psql -h localhost -U postgres -d postgres -c "SHOW ssl;"
#
# 2. Verify TLS version:
#    psql -h localhost -U postgres -d postgres -c "SELECT version, cipher FROM pg_stat_ssl;"
#
# 3. Test client certificate authentication:
#    psql "host=pg-coordinator dbname=distributed_postgres_cluster user=app_writer
#          sslmode=verify-full sslcert=/path/to/client.crt sslkey=/path/to/client.key
#          sslrootcert=/path/to/ca.crt"
#
# 4. Check cipher suite:
#    openssl s_client -connect pg-coordinator:5432 -starttls postgres
#
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# "could not load server certificate file"
#   - Check file permissions: chmod 600 /etc/postgresql/certs/server.key
#   - Verify file ownership: chown postgres:postgres /etc/postgresql/certs/*
#
# "certificate verify failed"
#   - Check CA certificate: openssl verify -CAfile ca.crt server.crt
#   - Verify certificate CN matches hostname
#
# "FATAL: no pg_hba.conf entry for host"
#   - Check pg_hba.conf has hostssl entries
#   - Verify client IP matches ADDRESS in pg_hba.conf
#
# "unsupported protocol"
#   - Client may not support TLS 1.3
#   - Temporarily set ssl_min_protocol_version = 'TLSv1.2' for testing
#
# ============================================================================
# MAINTENANCE
# ============================================================================
#
# Certificate Renewal (Annual):
#   1. Generate new certificates: scripts/security/generate-certificates.sh
#   2. Update Docker secrets: docker secret create postgres_server_cert_v2 server.crt
#   3. Update stack.yml to use new secrets
#   4. Rolling restart: docker service update --force postgres-coordinator
#
# CRL Update (Monthly):
#   1. Download new CRL from CA
#   2. Update /etc/postgresql/certs/crl.pem
#   3. Reload config: SELECT pg_reload_conf();
#
# ============================================================================

# End of TLS configuration
