# PostgreSQL Client Authentication Configuration File
# ===================================================
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# This file controls: which hosts are allowed to connect, how clients
# are authenticated, which PostgreSQL user names they can use, which
# databases they can access. Records take one of these forms:
#
# local         DATABASE  USER  METHOD  [OPTIONS]
# host          DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostssl       DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostnossl     DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostgssenc    DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
# hostnogssenc  DATABASE  USER  ADDRESS  METHOD  [OPTIONS]
#
# SECURITY: This configuration implements zero-trust principles
# All connections require SCRAM-SHA-256 authentication and TLS encryption

# ============================================================================
# LOCAL CONNECTIONS (Unix Domain Socket)
# ============================================================================

# Database superuser (local only, peer authentication)
local   all             postgres                                peer

# Other local users (require password)
local   all             all                                     scram-sha-256

# ============================================================================
# DOCKER OVERLAY NETWORK (10.0.10.0/24)
# ============================================================================

# Coordinator node (with client certificate verification)
hostssl all             cluster_admin   10.0.10.2/32            scram-sha-256 clientcert=verify-ca
hostssl all             dpg_cluster     10.0.10.2/32            scram-sha-256

# Replication connections (require client certificate)
hostssl replication     replicator      10.0.10.0/24            scram-sha-256 clientcert=verify-ca

# Worker nodes (mutual TLS authentication)
hostssl all             all             10.0.10.3/32            scram-sha-256 clientcert=verify-ca
hostssl all             all             10.0.10.4/32            scram-sha-256 clientcert=verify-ca
hostssl all             all             10.0.10.5/32            scram-sha-256 clientcert=verify-ca

# PgBouncer connection pooler
hostssl all             all             10.0.10.100/32          scram-sha-256

# Health monitor (read-only queries)
hostssl distributed_postgres_cluster monitor 10.0.10.0/24       scram-sha-256

# Backup agent
hostssl distributed_postgres_cluster backup_agent 10.0.10.0/24  scram-sha-256

# ============================================================================
# INTERNAL APPLICATION SUBNETS (Adjust based on your network)
# ============================================================================

# Application servers (requires client certificate for production)
hostssl all             app_writer      10.0.0.0/16             scram-sha-256 clientcert=verify-full
hostssl all             app_reader      10.0.0.0/16             scram-sha-256 clientcert=verify-full

# Service accounts (each service should have dedicated credentials)
hostssl all             analytics_service 10.0.0.0/16           scram-sha-256 clientcert=verify-full
hostssl all             api_service       10.0.0.0/16           scram-sha-256 clientcert=verify-full

# ============================================================================
# EXTERNAL CLIENTS (Public Internet) - REQUIRES FULL CERTIFICATE VERIFICATION
# ============================================================================

# Only allow connections with valid client certificates
hostssl all             all             0.0.0.0/0               scram-sha-256 clientcert=verify-full

# IPv6 support
hostssl all             all             ::/0                    scram-sha-256 clientcert=verify-full

# ============================================================================
# DENY ALL OTHER CONNECTIONS (Explicit Deny)
# ============================================================================

# Reject unencrypted connections
hostnossl all           all             all                     reject

# Reject any connection not matching above rules
host      all           all             all                     reject

# ============================================================================
# SECURITY NOTES:
# ============================================================================
# 1. SCRAM-SHA-256 is the strongest password authentication method
# 2. clientcert=verify-ca: Verifies certificate is signed by trusted CA
# 3. clientcert=verify-full: Also verifies certificate CN matches username
# 4. All production connections should use hostssl (not host)
# 5. Update addresses to match your actual network topology
# 6. Test changes with: psql -h <host> -U <user> -d <database>
# 7. Reload config: SELECT pg_reload_conf();
# ============================================================================

# ============================================================================
# TROUBLESHOOTING:
# ============================================================================
# Connection refused?
#   - Check postgresql.conf: listen_addresses = '*'
#   - Check firewall: iptables -L -n | grep 5432
#   - Check Docker network: docker network inspect postgres_mesh
#
# Authentication failed?
#   - Check password encryption: SHOW password_encryption;
#   - Check user exists: SELECT usename FROM pg_user;
#   - Check client certificate: openssl x509 -in client.crt -text -noout
#
# Permission denied?
#   - Check role grants: \du+ in psql
#   - Check database privileges: \l+ in psql
#   - Check table permissions: \dp tablename
# ============================================================================
