# HAProxy Configuration for Distributed PostgreSQL Cluster
# Patroni-aware routing with health checks

global
    log stdout format raw local0
    maxconn 10000
    # Performance tuning
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 10s
    timeout client 1h
    timeout server 1h
    timeout check 5s

# ============================================================
# Statistics Page
# ============================================================
listen stats
    mode http
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats show-legends
    stats show-node
    stats admin if LOCALHOST

# ============================================================
# PostgreSQL Primary (Write) Frontend
# ============================================================
frontend postgres_primary
    description "PostgreSQL primary coordinator (writes)"
    bind *:5432
    mode tcp
    option tcplog
    default_backend postgres_primary_backend

# ============================================================
# PostgreSQL Primary (Write) Backend
# ============================================================
backend postgres_primary_backend
    description "PostgreSQL primary coordinator backend"
    mode tcp
    option tcp-check
    option log-health-checks

    # Health check via Patroni REST API
    # Check if node is primary (leader)
    tcp-check connect port 8008
    tcp-check send GET\ /leader\ HTTP/1.0\r\n\r\n
    tcp-check expect string 200\ OK

    # Connection to PostgreSQL port
    default-server inter 2s fall 3 rise 2 on-marked-down shutdown-sessions

    # Coordinator nodes
    server coordinator-1 coordinator-1:5432 check port 8008
    server coordinator-2 coordinator-2:5432 check port 8008
    server coordinator-3 coordinator-3:5432 check port 8008

# ============================================================
# PostgreSQL Replica (Read) Frontend
# ============================================================
frontend postgres_replica
    description "PostgreSQL replica coordinators (reads)"
    bind *:5433
    mode tcp
    option tcplog
    default_backend postgres_replica_backend

# ============================================================
# PostgreSQL Replica (Read) Backend
# ============================================================
backend postgres_replica_backend
    description "PostgreSQL replica coordinator backend (read-only)"
    mode tcp
    option tcp-check
    option log-health-checks
    balance leastconn

    # Health check via Patroni REST API
    # Check if node is replica
    tcp-check connect port 8008
    tcp-check send GET\ /replica\ HTTP/1.0\r\n\r\n
    tcp-check expect string 200\ OK

    default-server inter 2s fall 3 rise 2 on-marked-down shutdown-sessions

    # Coordinator nodes (will only route to replicas)
    server coordinator-1 coordinator-1:5432 check port 8008
    server coordinator-2 coordinator-2:5432 check port 8008
    server coordinator-3 coordinator-3:5432 check port 8008

# ============================================================
# PostgreSQL Any (Read/Write) Frontend
# ============================================================
frontend postgres_any
    description "PostgreSQL any coordinator (read or write)"
    bind *:5434
    mode tcp
    option tcplog
    default_backend postgres_any_backend

# ============================================================
# PostgreSQL Any (Read/Write) Backend
# ============================================================
backend postgres_any_backend
    description "PostgreSQL any coordinator backend"
    mode tcp
    option tcp-check
    option log-health-checks
    balance roundrobin

    # Health check via Patroni REST API
    # Check if node is running (primary or replica)
    tcp-check connect port 8008
    tcp-check send GET\ /health\ HTTP/1.0\r\n\r\n
    tcp-check expect string 200\ OK

    default-server inter 2s fall 3 rise 2 on-marked-down shutdown-sessions

    # Coordinator nodes
    server coordinator-1 coordinator-1:5432 check port 8008
    server coordinator-2 coordinator-2:5432 check port 8008
    server coordinator-3 coordinator-3:5432 check port 8008

# ============================================================
# Patroni REST API Frontend (for monitoring)
# ============================================================
frontend patroni_api
    description "Patroni REST API"
    bind *:8008
    mode http
    option httplog
    default_backend patroni_api_backend

# ============================================================
# Patroni REST API Backend
# ============================================================
backend patroni_api_backend
    description "Patroni REST API backend"
    mode http
    option httpchk GET /health
    balance roundrobin

    default-server inter 2s fall 3 rise 2

    # All Patroni nodes
    server coordinator-1 coordinator-1:8008 check
    server coordinator-2 coordinator-2:8008 check
    server coordinator-3 coordinator-3:8008 check
