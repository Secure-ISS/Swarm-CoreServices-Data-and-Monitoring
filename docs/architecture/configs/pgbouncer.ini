; PgBouncer Configuration for Distributed PostgreSQL Cluster
; Transaction pooling mode for optimal OLTP performance

[databases]
; Database aliases
distributed_postgres_cluster = host=localhost port=5432 dbname=distributed_postgres_cluster
postgres = host=localhost port=5432 dbname=postgres
claude_flow_shared = host=localhost port=5432 dbname=claude_flow_shared

; Fallback pool (connects to any database on the server)
* = host=localhost port=5432

[pgbouncer]
;;;
;;; Administrative settings
;;;

logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

;;;
;;; Where to wait for clients
;;;

listen_addr = 0.0.0.0
listen_port = 6432

; Unix socket location
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777

;;;
;;; Authentication settings
;;;

auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

; Pre-computed md5 hash
; Format: "username" "md5<md5 of password + username>"
; Example: "postgres" "md5d8578edf8458ce06fbc5bb76a58c5ca4"

;;;
;;; Connection limits
;;;

; Maximum number of client connections allowed
max_client_conn = 10000

; Maximum number of server connections per database
default_pool_size = 25

; Reserve connections for higher-priority clients
reserve_pool_size = 5

; Timeout for acquiring a connection from reserve pool
reserve_pool_timeout = 3

; Maximum number of server connections (total across all databases)
max_db_connections = 100

; Maximum number of connections per user
max_user_connections = 0

;;;
;;; Pooling mode
;;;

; session - connections are pooled when client disconnects
; transaction - connections are pooled when transaction ends (COMMIT/ROLLBACK)
; statement - connections are pooled after each statement (not recommended)
pool_mode = transaction

;;;
;;; Timeouts
;;;

; Close server connections if they have been idle for this long
server_idle_timeout = 600

; Close client connections if they have been idle for this long
client_idle_timeout = 3600

; If a client has been waiting longer than this, close the connection
query_timeout = 0

; Close client connection if it doesn't finish login within this time
query_wait_timeout = 120

; Drop connections if they have been in "idle in transaction" state for this long
idle_transaction_timeout = 0

; Disconnect clients who have been waiting longer than this for a server connection
server_connect_timeout = 15

;;;
;;; Dangerous timeouts
;;;

; Drop connections if the underlying TCP connection has been idle for this long
; Useful for detecting dead connections
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

;;;
;;; Low-level network settings
;;;

; TCP buffer sizes
pkt_buf = 4096
listen_backlog = 128

;;;
;;; TLS settings (optional, for encrypted connections)
;;;

; client_tls_sslmode = disable
; client_tls_key_file =
; client_tls_cert_file =
; client_tls_ca_file =
; client_tls_protocols = secure
; client_tls_ciphers = default

; server_tls_sslmode = prefer
; server_tls_key_file =
; server_tls_cert_file =
; server_tls_ca_file =
; server_tls_protocols = secure
; server_tls_ciphers = default

;;;
;;; Logging
;;;

; Log level: 0 - quiet, 1 - normal, 2 - verbose, 3 - debug
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1

; How often to log stats (in seconds)
stats_period = 60

;;;
;;; Console access
;;;

; Users allowed to access admin console
; Format: user1, user2, ...
admin_users = postgres

; Password for admin user (from auth_file)

;;;
;;; Connection sanity checks, timeouts
;;;

; Check query sent to server on new connection
; Useful for catching configuration changes
; server_check_query = SELECT 1
server_check_delay = 30

; If server was used more recently than this, skip check query
server_fast_close = 0

;;;
;;; Performance tuning
;;;

; How many server connections to prepare before accepting client connections
min_pool_size = 0

; Add more server connections if pool is nearly full
server_lifetime = 3600

; How long unused connections can stay attached to the client
server_idle_timeout = 600

;;;
;;; Autodb
;;;

; Automatically create database entries based on connection requests
; autodb_idle_timeout = 3600

;;;
;;; Extra parameters
;;;

; Disable expensive operations
disable_pqexec = 0

; Forward COPY protocol directly to server (don't buffer in pgbouncer)
; Only works in transaction pooling mode
application_name_add_host = 1

;;;
;;; Performance recommendations for distributed PostgreSQL
;;;

; For Citus distributed queries, we want:
; 1. Transaction pooling (already set)
; 2. High connection limits (already set)
; 3. Low timeouts for fast failover
; 4. TCP keepalive for dead connection detection

; Monitoring query (for Prometheus exporter)
; SELECT * FROM pgbouncer.stats;
; SELECT * FROM pgbouncer.pools;
; SELECT * FROM pgbouncer.databases;
